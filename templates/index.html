<html>
    <head>
        <title>mintcam</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
    </head>
    <body>
        <h1>mintcam | {{ config.name }}</h1>

        <div class="controls">
            <form
                id="camera-settings"
                action="{{ url_for('set_resolution') }}"
                method="post"
            >
                <label for="resolution">Resolution & FPS:</label>
                <select id="resolution" name="resolution">
                    <option value="640x480x30" selected>
                        640 x 480p30 (Default)
                    </option>
                    <option value="1536x864x30">1536 x 864p30</option>
                    <option value="2304x1296x30">2304 x 1296p30</option>
                    <option value="4608x2592x30">4608 x 2592p30</option>
                </select>
                <button type="submit">Apply</button>
            </form>
        </div>

        <div class="picture-controls">
            <button
                id="take-picture-btn"
                class="take-picture-btn"
                type="button"
            >
                Take Picture
            </button>
            <div id="status-message" class="status-message"></div>
        </div>

        <div class="recorder-controls">
            <h3>Schedule Recorders</h3>
            <div class="recorder-form">
                <label for="recorder-hour">Hour Interval:</label>
                <input
                    type="number"
                    id="recorder-hour"
                    min="0"
                    max="23"
                    placeholder="0"
                />

                <label for="recorder-minute">Minute:</label>
                <input
                    type="number"
                    id="recorder-minute"
                    min="0"
                    max="59"
                    placeholder="30"
                    required
                />

                <button
                    type="button"
                    class="add-recorder-btn"
                    id="add-recorder-btn"
                >
                    Add Recorder
                </button>
            </div>
            <div id="recorder-status" class="recorder-status"></div>

            <div class="recorder-list">
                <h4>Active Recorders</h4>
                <div id="recorder-list">
                    <p>Loading recorders...</p>
                </div>
            </div>
        </div>

        <div class="stream-container">
            <img
                src="{{ url_for('live_video_feed') }}"
                style="width: 100%; border-radius: 5px"
            />
        </div>

        <div class="picture-gallery">
            <h3>Recent Pictures</h3>
            <div id="picture-list">
                <p>Loading pictures...</p>
            </div>
        </div>

        <script>
            // Camera settings form handler
            document
                .getElementById("camera-settings")
                .addEventListener("submit", function (e) {
                    e.preventDefault();
                    const resolution =
                        document.getElementById("resolution").value;

                    fetch('{{ url_for("set_resolution") }}', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "resolution=" + resolution,
                    }).then((response) => {
                        if (response.ok) {
                            // Reload the video feed by forcing the img to refresh
                            const img = document.querySelector(
                                ".stream-container img",
                            );
                            const src = img.src;
                            img.src = "";
                            setTimeout(() => {
                                img.src = src + "?" + new Date().getTime();
                            }, 500);
                        }
                    });
                });

            // Take picture button handler
            document
                .getElementById("take-picture-btn")
                .addEventListener("click", function () {
                    const button = this;
                    const statusDiv = document.getElementById("status-message");

                    // Disable button and show loading
                    button.disabled = true;
                    button.textContent = "Taking Picture...";

                    fetch("/take_picture", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                statusDiv.className =
                                    "status-message status-success";
                                statusDiv.textContent = `Picture saved: ${data.filename}`;
                                statusDiv.style.display = "block";
                                loadPictures(); // Refresh the gallery
                            } else {
                                statusDiv.className =
                                    "status-message status-error";
                                statusDiv.textContent = `Error: ${data.message}`;
                                statusDiv.style.display = "block";
                            }
                        })
                        .catch((error) => {
                            statusDiv.className = "status-message status-error";
                            statusDiv.textContent = `Error: ${error.message}`;
                            statusDiv.style.display = "block";
                        })
                        .finally(() => {
                            // Re-enable button
                            button.disabled = false;
                            button.textContent = "Take Picture";

                            // Hide status message after 3 seconds
                            setTimeout(() => {
                                statusDiv.style.display = "none";
                            }, 3000);
                        });
                });

            // Load and display pictures
            function loadPictures() {
                fetch("/pictures")
                    .then((response) => response.json())
                    .then((data) => {
                        const pictureList =
                            document.getElementById("picture-list");

                        if (data.success && data.pictures.length > 0) {
                            pictureList.innerHTML = data.pictures
                                .slice(0, 10) // Show only last 10 pictures
                                .map(
                                    (picture) => `
                                    <div class="picture-item">
                                        <img src="/pictures/${picture.filename}"
                                             class="picture-thumbnail"
                                             alt="${picture.filename}"
                                             onclick="window.open('/pictures/${picture.filename}', '_blank')">
                                        <div class="picture-info">
                                            ${picture.filename}<br>
                                            ${new Date(picture.created).toLocaleString()}
                                        </div>
                                    </div>
                                `,
                                )
                                .join("");
                        } else {
                            pictureList.innerHTML =
                                "<p>No pictures taken yet.</p>";
                        }
                    })
                    .catch((error) => {
                        document.getElementById("picture-list").innerHTML =
                            "<p>Error loading pictures.</p>";
                    });
            }

            // Load pictures when page loads
            document.addEventListener("DOMContentLoaded", loadPictures);

            // Recorder functionality
            document
                .getElementById("add-recorder-btn")
                .addEventListener("click", function () {
                    const button = this;
                    const statusDiv =
                        document.getElementById("recorder-status");
                    const hourInput = document.getElementById("recorder-hour");
                    const minuteInput =
                        document.getElementById("recorder-minute");

                    const hour = parseInt(hourInput.value) || 0;
                    const minute = parseInt(minuteInput.value);

                    if (isNaN(minute) || minute < 0 || minute > 59) {
                        showRecorderStatus(
                            "Error: Minute must be between 0 and 59",
                            "error",
                        );
                        return;
                    }

                    if (hour < 0 || hour > 23) {
                        showRecorderStatus(
                            "Error: Hour interval must be between 0 and 23",
                            "error",
                        );
                        return;
                    }

                    button.disabled = true;
                    button.textContent = "Adding...";

                    fetch("/create_recorder", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            hour: hour,
                            minute: minute,
                            name: `Recorder ${hour}h ${minute}m`,
                        }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                showRecorderStatus(data.message, "success");
                                hourInput.value = "";
                                minuteInput.value = "";
                                loadRecorders();
                            } else {
                                showRecorderStatus(
                                    `Error: ${data.message}`,
                                    "error",
                                );
                            }
                        })
                        .catch((error) => {
                            showRecorderStatus(
                                `Error: ${error.message}`,
                                "error",
                            );
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = "Add Recorder";
                        });
                });

            function showRecorderStatus(message, type) {
                const statusDiv = document.getElementById("recorder-status");
                statusDiv.className = `recorder-status status-${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = "block";

                setTimeout(() => {
                    statusDiv.style.display = "none";
                }, 5000);
            }

            function loadRecorders() {
                fetch("/list_recorders")
                    .then((response) => response.json())
                    .then((data) => {
                        const recorderList =
                            document.getElementById("recorder-list");

                        if (data.success && data.recorders.length > 0) {
                            recorderList.innerHTML = data.recorders
                                .map(
                                    (recorder) => `
                            <div class="recorder-item">
                                <div class="recorder-info">
                                    <div class="recorder-schedule">
                                        Every ${recorder.hour === 0 ? "" : recorder.hour + " hours, "}${recorder.minute} minutes
                                    </div>
                                    <div class="recorder-cron">${recorder.cron_expression}</div>
                                </div>
                                <button class="delete-recorder-btn"
                                        onclick="deleteRecorder(${recorder.hour}, ${recorder.minute})">
                                    Delete
                                </button>
                            </div>
                        `,
                                )
                                .join("");
                        } else {
                            recorderList.innerHTML =
                                "<p>No active recorders.</p>";
                        }
                    })
                    .catch((error) => {
                        document.getElementById("recorder-list").innerHTML =
                            "<p>Error loading recorders.</p>";
                    });
            }

            function deleteRecorder(hour, minute) {
                if (
                    !confirm(
                        `Delete recorder for every ${hour === 0 ? "" : hour + " hours, "}${minute} minutes?`,
                    )
                ) {
                    return;
                }

                fetch("/delete_recorder", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        hour: hour,
                        minute: minute,
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showRecorderStatus(data.message, "success");
                            loadRecorders();
                        } else {
                            showRecorderStatus(
                                `Error: ${data.message}`,
                                "error",
                            );
                        }
                    })
                    .catch((error) => {
                        showRecorderStatus(`Error: ${error.message}`, "error");
                    });
            }

            // Load recorders when page loads
            document.addEventListener("DOMContentLoaded", loadRecorders);
        </script>
    </body>
</html>
