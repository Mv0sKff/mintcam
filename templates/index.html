<html>
    <head>
        <title>mintcam</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
    </head>
    <body>
        <h1>mintcam | {{ config.name }}</h1>

        <div class="controls">
            <form
                id="camera-settings"
                action="{{ url_for('set_resolution') }}"
                method="post"
            >
                <label for="resolution">Resolution & FPS:</label>
                <select id="resolution" name="resolution">
                    <option value="640x480x30" selected>
                        640 x 480p30 (Default)
                    </option>
                    <option value="1536x864x30">1536 x 864p30</option>
                    <option value="2304x1296x30">2304 x 1296p30</option>
                    <option value="4608x2592x30">4608 x 2592p30</option>
                </select>
                <button type="submit">Apply</button>
            </form>
        </div>

        <div class="picture-controls">
            <button
                id="take-picture-btn"
                class="take-picture-btn"
                type="button"
            >
                Take Picture
            </button>
            <button
                id="record-video-btn"
                class="record-video-btn"
                type="button"
            >
                Record Video
            </button>
            <input
                type="number"
                id="manual-video-duration"
                min="1"
                max="30"
                value="10"
                placeholder="10"
                style="width: 60px; margin-left: 10px"
            />
            <label for="manual-video-duration" style="margin-left: 5px"
                >seconds</label
            >
            <div id="status-message" class="status-message"></div>
        </div>

        <div class="recorder-controls">
            <h3>Schedule Recorders</h3>
            <div class="recorder-form">
                <label for="recorder-hour">Hour Interval:</label>
                <input
                    type="number"
                    id="recorder-hour"
                    min="0"
                    max="23"
                    placeholder="0"
                />

                <label for="recorder-minute">Minute:</label>
                <input
                    type="number"
                    id="recorder-minute"
                    min="0"
                    max="59"
                    placeholder="30"
                    required
                />

                <label for="record-type">Type:</label>
                <select id="record-type">
                    <option value="picture">Picture</option>
                    <option value="video">Video</option>
                </select>

                <label
                    for="video-duration"
                    id="duration-label"
                    style="display: none"
                    >Duration (s):</label
                >
                <input
                    type="number"
                    id="video-duration"
                    min="1"
                    max="30"
                    placeholder="30"
                    style="display: none"
                />

                <button
                    type="button"
                    class="add-recorder-btn"
                    id="add-recorder-btn"
                >
                    Add Recorder
                </button>
            </div>
            <div id="recorder-status" class="recorder-status"></div>

            <div class="recorder-list">
                <h4>Active Recorders</h4>
                <div id="recorder-list">
                    <p>Loading recorders...</p>
                </div>
            </div>
        </div>

        <div class="stream-container">
            <img
                src="{{ url_for('live_video_feed') }}"
                style="width: 100%; border-radius: 5px"
            />
        </div>

        <div class="help-section">
            <h3>Help & Shortcuts</h3>
            <div class="help-content">
                <div class="keyboard-shortcuts">
                    <h4>Keyboard Shortcuts:</h4>
                    <ul>
                        <li><kbd>Ctrl/Cmd + P</kbd> - Take Picture</li>
                        <li><kbd>Ctrl/Cmd + V</kbd> - Record Video</li>
                        <li><kbd>Ctrl/Cmd + D</kbd> - Download All Pictures</li>
                        <li>
                            <kbd>Ctrl/Cmd + Shift + D</kbd> - Download All
                            Videos
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="picture-gallery">
            <h3>Recent Pictures</h3>
            <button
                id="download-all-pictures-btn"
                class="download-all-btn"
                type="button"
                onclick="downloadAllPictures()"
            >
                Download All Pictures
            </button>
            <button
                id="delete-all-pictures-btn"
                class="delete-all-btn"
                type="button"
                onclick="deleteAllPictures()"
            >
                Delete All Pictures
            </button>
            <div id="picture-list">
                <p>Loading pictures...</p>
            </div>
        </div>

        <div class="video-gallery">
            <h3>Recent Videos</h3>
            <button
                id="download-all-videos-btn"
                class="download-all-btn"
                type="button"
                onclick="downloadAllVideos()"
            >
                Download All Videos
            </button>
            <button
                id="delete-all-videos-btn"
                class="delete-all-btn"
                type="button"
                onclick="deleteAllVideos()"
            >
                Delete All Videos
            </button>
            <div id="video-list">
                <p>Loading videos...</p>
            </div>
        </div>

        <script>
            // Camera settings form handler
            document
                .getElementById("camera-settings")
                .addEventListener("submit", function (e) {
                    e.preventDefault();
                    const resolution =
                        document.getElementById("resolution").value;

                    fetch('{{ url_for("set_resolution") }}', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: "resolution=" + resolution,
                    }).then((response) => {
                        if (response.ok) {
                            // Reload the video feed by forcing the img to refresh
                            const img = document.querySelector(
                                ".stream-container img",
                            );
                            const src = img.src;
                            img.src = "";
                            setTimeout(() => {
                                img.src = src + "?" + new Date().getTime();
                            }, 500);
                        }
                    });
                });

            // Take picture button handler
            document
                .getElementById("take-picture-btn")
                .addEventListener("click", function () {
                    const button = this;
                    const statusDiv = document.getElementById("status-message");

                    // Disable button and show loading
                    button.disabled = true;
                    button.textContent = "Taking Picture...";

                    fetch("/take_picture", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                statusDiv.className =
                                    "status-message status-success";
                                statusDiv.textContent = `Picture saved: ${data.filename}`;
                                statusDiv.style.display = "block";
                                loadPictures(); // Refresh the gallery
                            } else {
                                statusDiv.className =
                                    "status-message status-error";
                                statusDiv.textContent = `Error: ${data.message}`;
                                statusDiv.style.display = "block";
                            }
                        })
                        .catch((error) => {
                            statusDiv.className = "status-message status-error";
                            statusDiv.textContent = `Error: ${error.message}`;
                            statusDiv.style.display = "block";
                        })
                        .finally(() => {
                            // Re-enable button
                            button.disabled = false;
                            button.textContent = "Take Picture";

                            // Hide status message after 3 seconds
                            setTimeout(() => {
                                statusDiv.style.display = "none";
                            }, 3000);
                        });
                });

            // Load and display pictures
            function loadPictures() {
                fetch("/pictures")
                    .then((response) => response.json())
                    .then((data) => {
                        const pictureList =
                            document.getElementById("picture-list");

                        if (data.success && data.pictures.length > 0) {
                            pictureList.innerHTML = data.pictures
                                .slice(0, 10) // Show only last 10 pictures
                                .map(
                                    (picture) => `
                                    <div class="picture-item">
                                        <img src="/pictures/${picture.filename}"
                                             class="picture-thumbnail"
                                             alt="${picture.filename}"
                                             onclick="window.open('/pictures/${picture.filename}', '_blank')">
                                        <div class="picture-info">
                                            ${picture.filename}<br>
                                            ${new Date(picture.created).toLocaleString()}<br>
                                            <button class="download-btn" onclick="downloadPicture('${picture.filename}')">
                                                Download
                                            </button>
                                            <button class="delete-btn" onclick="deletePicture('${picture.filename}')">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `,
                                )
                                .join("");
                        } else {
                            pictureList.innerHTML =
                                "<p>No pictures taken yet.</p>";
                        }
                    })
                    .catch((error) => {
                        document.getElementById("picture-list").innerHTML =
                            "<p>Error loading pictures.</p>";
                    });
            }

            // Record video button handler
            document
                .getElementById("record-video-btn")
                .addEventListener("click", function () {
                    const button = this;
                    const statusDiv = document.getElementById("status-message");
                    const durationInput = document.getElementById(
                        "manual-video-duration",
                    );
                    const duration = parseInt(durationInput.value) || 10;

                    // Disable button and show loading
                    button.disabled = true;
                    button.textContent = "Recording...";

                    fetch("/record_video", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ duration: duration }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                statusDiv.className =
                                    "status-message status-success";
                                statusDiv.textContent = `Video saved: ${data.filename}`;
                                statusDiv.style.display = "block";
                                loadVideos(); // Refresh the gallery
                            } else {
                                statusDiv.className =
                                    "status-message status-error";
                                statusDiv.textContent = `Error: ${data.message}`;
                                statusDiv.style.display = "block";
                            }
                        })
                        .catch((error) => {
                            statusDiv.className = "status-message status-error";
                            statusDiv.textContent = `Error: ${error.message}`;
                            statusDiv.style.display = "block";
                        })
                        .finally(() => {
                            // Re-enable button
                            button.disabled = false;
                            button.textContent = "Record Video";

                            // Hide status message after 3 seconds
                            setTimeout(() => {
                                statusDiv.style.display = "none";
                            }, 3000);
                        });
                });

            // Load pictures when page loads
            document.addEventListener("DOMContentLoaded", loadPictures);

            // Load and display videos
            function loadVideos() {
                fetch("/videos")
                    .then((response) => response.json())
                    .then((data) => {
                        const videoList = document.getElementById("video-list");

                        if (data.success && data.videos.length > 0) {
                            videoList.innerHTML = data.videos
                                .slice(0, 10) // Show only last 10 videos
                                .map(
                                    (video) => `
                                    <div class="video-item">
                                        <video src="/videos/${video.filename}"
                                               class="video-thumbnail"
                                               controls
                                               onclick="window.open('/videos/${video.filename}', '_blank')">
                                        </video>
                                        <div class="video-info">
                                            ${video.filename}<br>
                                            ${new Date(video.created).toLocaleString()}<br>
                                            <button class="download-btn" onclick="downloadVideo('${video.filename}')">
                                                Download
                                            </button>
                                            <button class="delete-btn" onclick="deleteVideo('${video.filename}')">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                `,
                                )
                                .join("");
                        } else {
                            videoList.innerHTML =
                                "<p>No videos recorded yet.</p>";
                        }
                    })
                    .catch((error) => {
                        document.getElementById("video-list").innerHTML =
                            "<p>Error loading videos.</p>";
                    });
            }

            // Load videos when page loads
            document.addEventListener("DOMContentLoaded", loadVideos);

            // Show/hide duration field based on record type
            document
                .getElementById("record-type")
                .addEventListener("change", function () {
                    const recordType = this.value;
                    const durationLabel =
                        document.getElementById("duration-label");
                    const durationInput =
                        document.getElementById("video-duration");

                    if (recordType === "video") {
                        durationLabel.style.display = "inline";
                        durationInput.style.display = "inline";
                    } else {
                        durationLabel.style.display = "none";
                        durationInput.style.display = "none";
                    }
                });

            // Recorder functionality
            document
                .getElementById("add-recorder-btn")
                .addEventListener("click", function () {
                    const button = this;
                    const statusDiv =
                        document.getElementById("recorder-status");
                    const hourInput = document.getElementById("recorder-hour");
                    const minuteInput =
                        document.getElementById("recorder-minute");
                    const recordTypeSelect =
                        document.getElementById("record-type");
                    const durationInput =
                        document.getElementById("video-duration");

                    const hour = parseInt(hourInput.value) || 0;
                    const minute = parseInt(minuteInput.value);
                    const recordType = recordTypeSelect.value;
                    const duration =
                        recordType === "video"
                            ? parseInt(durationInput.value) || 30
                            : null;

                    if (isNaN(minute) || minute < 0 || minute > 59) {
                        showRecorderStatus(
                            "Error: Minute must be between 0 and 59",
                            "error",
                        );
                        return;
                    }

                    if (hour < 0 || hour > 23) {
                        showRecorderStatus(
                            "Error: Hour interval must be between 0 and 23",
                            "error",
                        );
                        return;
                    }

                    button.disabled = true;
                    button.textContent = "Adding...";

                    const requestBody = {
                        hour: hour,
                        minute: minute,
                        record_type: recordType,
                        name: `Recorder ${hour}h ${minute}m (${recordType})`,
                    };

                    if (recordType === "video") {
                        requestBody.duration = duration;
                    }

                    fetch("/create_recorder", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(requestBody),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success) {
                                showRecorderStatus(data.message, "success");
                                hourInput.value = "";
                                minuteInput.value = "";
                                recordTypeSelect.value = "picture";
                                durationInput.value = "";
                                durationInput.style.display = "none";
                                document.getElementById(
                                    "duration-label",
                                ).style.display = "none";
                                loadRecorders();
                            } else {
                                showRecorderStatus(
                                    `Error: ${data.message}`,
                                    "error",
                                );
                            }
                        })
                        .catch((error) => {
                            showRecorderStatus(
                                `Error: ${error.message}`,
                                "error",
                            );
                        })
                        .finally(() => {
                            button.disabled = false;
                            button.textContent = "Add Recorder";
                        });
                });

            function showRecorderStatus(message, type) {
                const statusDiv = document.getElementById("recorder-status");
                statusDiv.className = `recorder-status status-${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = "block";

                setTimeout(() => {
                    statusDiv.style.display = "none";
                }, 5000);
            }

            function loadRecorders() {
                fetch("/list_recorders")
                    .then((response) => response.json())
                    .then((data) => {
                        const recorderList =
                            document.getElementById("recorder-list");

                        if (data.success && data.recorders.length > 0) {
                            recorderList.innerHTML = data.recorders
                                .map(
                                    (recorder) => `
                            <div class="recorder-item">
                                <div class="recorder-info">
                                    <div class="recorder-schedule">
                                        Every ${recorder.hour === 0 ? "" : recorder.hour + " hours, "}${recorder.minute} minutes
                                        ${recorder.record_type === "video" ? `(Video ${recorder.duration || 30}s)` : "(Picture)"}
                                    </div>
                                    <div class="recorder-cron">${recorder.cron_expression}</div>
                                </div>
                                <button class="delete-recorder-btn"
                                        onclick="deleteRecorder(${recorder.hour}, ${recorder.minute})">
                                    Delete
                                </button>
                            </div>
                        `,
                                )
                                .join("");
                        } else {
                            recorderList.innerHTML =
                                "<p>No active recorders.</p>";
                        }
                    })
                    .catch((error) => {
                        document.getElementById("recorder-list").innerHTML =
                            "<p>Error loading recorders.</p>";
                    });
            }

            function deleteRecorder(hour, minute) {
                if (
                    !confirm(
                        `Delete recorder for every ${hour === 0 ? "" : hour + " hours, "}${minute} minutes?`,
                    )
                ) {
                    return;
                }

                fetch("/delete_recorder", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        hour: hour,
                        minute: minute,
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showRecorderStatus(data.message, "success");
                            loadRecorders();
                        } else {
                            showRecorderStatus(
                                `Error: ${data.message}`,
                                "error",
                            );
                        }
                    })
                    .catch((error) => {
                        showRecorderStatus(`Error: ${error.message}`, "error");
                    });
            }

            // Load recorders when page loads
            document.addEventListener("DOMContentLoaded", loadRecorders);

            // Delete picture function
            function deletePicture(filename) {
                if (
                    !confirm(`Are you sure you want to delete "${filename}"?`)
                ) {
                    return;
                }

                showDeleteStatus("Deleting picture...", "info");

                fetch(`/delete_picture/${filename}`, {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showDeleteStatus(data.message, "success");
                            loadPictures(); // Refresh the gallery
                        } else {
                            showDeleteStatus(`Error: ${data.message}`, "error");
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus(`Error: ${error.message}`, "error");
                    });
            }

            // Delete video function
            function deleteVideo(filename) {
                if (
                    !confirm(`Are you sure you want to delete "${filename}"?`)
                ) {
                    return;
                }

                showDeleteStatus("Deleting video...", "info");

                fetch(`/delete_video/${filename}`, {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showDeleteStatus(data.message, "success");
                            loadVideos(); // Refresh the gallery
                        } else {
                            showDeleteStatus(`Error: ${data.message}`, "error");
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus(`Error: ${error.message}`, "error");
                    });
            }

            // Show delete status message
            function showDeleteStatus(message, type) {
                const statusDiv = document.getElementById("status-message");
                statusDiv.className = `status-message status-${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = "block";

                setTimeout(() => {
                    statusDiv.style.display = "none";
                }, 3000);
            }

            // Delete all pictures function
            function deleteAllPictures() {
                if (
                    !confirm(
                        "Are you sure you want to delete ALL pictures? This action cannot be undone!",
                    )
                ) {
                    return;
                }

                const button = document.getElementById(
                    "delete-all-pictures-btn",
                );
                button.disabled = true;
                button.textContent = "Deleting...";
                showDeleteStatus("Deleting all pictures...", "info");

                fetch("/delete_all_pictures", {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showDeleteStatus(data.message, "success");
                            loadPictures(); // Refresh the gallery
                        } else {
                            showDeleteStatus(`Error: ${data.message}`, "error");
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus(`Error: ${error.message}`, "error");
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = "Delete All Pictures";
                    });
            }

            // Delete all videos function
            function deleteAllVideos() {
                if (
                    !confirm(
                        "Are you sure you want to delete ALL videos? This action cannot be undone!",
                    )
                ) {
                    return;
                }

                const button = document.getElementById("delete-all-videos-btn");
                button.disabled = true;
                button.textContent = "Deleting...";
                showDeleteStatus("Deleting all videos...", "info");

                fetch("/delete_all_videos", {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            showDeleteStatus(data.message, "success");
                            loadVideos(); // Refresh the gallery
                        } else {
                            showDeleteStatus(`Error: ${data.message}`, "error");
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus(`Error: ${error.message}`, "error");
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = "Delete All Videos";
                    });
            }

            // Download individual picture
            function downloadPicture(filename) {
                const link = document.createElement("a");
                link.href = `/pictures/${filename}?download=true`;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showDeleteStatus(`Downloading ${filename}...`, "success");
            }

            // Download individual video
            function downloadVideo(filename) {
                const link = document.createElement("a");
                link.href = `/videos/${filename}?download=true`;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showDeleteStatus(`Downloading ${filename}...`, "success");
            }

            // Download all pictures
            function downloadAllPictures() {
                const button = document.getElementById(
                    "download-all-pictures-btn",
                );
                button.disabled = true;
                button.textContent = "Preparing...";
                showDeleteStatus("Preparing pictures download...", "info");

                // Check if there are any pictures first
                fetch("/pictures")
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success && data.pictures.length > 0) {
                            const link = document.createElement("a");
                            link.href = "/download_all_pictures";
                            link.download = "";
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showDeleteStatus(
                                `Downloading ${data.pictures.length} pictures as ZIP...`,
                                "success",
                            );
                        } else {
                            showDeleteStatus(
                                "No pictures available to download",
                                "error",
                            );
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus("Error checking pictures", "error");
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = "Download All Pictures";
                    });
            }

            // Download all videos
            function downloadAllVideos() {
                const button = document.getElementById(
                    "download-all-videos-btn",
                );
                button.disabled = true;
                button.textContent = "Preparing...";
                showDeleteStatus("Preparing videos download...", "info");

                // Check if there are any videos first
                fetch("/videos")
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success && data.videos.length > 0) {
                            const link = document.createElement("a");
                            link.href = "/download_all_videos";
                            link.download = "";
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showDeleteStatus(
                                `Downloading ${data.videos.length} videos as ZIP...`,
                                "success",
                            );
                        } else {
                            showDeleteStatus(
                                "No videos available to download",
                                "error",
                            );
                        }
                    })
                    .catch((error) => {
                        showDeleteStatus("Error checking videos", "error");
                    })
                    .finally(() => {
                        button.disabled = false;
                        button.textContent = "Download All Videos";
                    });
            }

            // Keyboard shortcuts
            document.addEventListener("keydown", function (e) {
                // Only trigger shortcuts if not in an input field
                if (
                    e.target.tagName === "INPUT" ||
                    e.target.tagName === "SELECT" ||
                    e.target.tagName === "TEXTAREA"
                ) {
                    return;
                }

                // Ctrl/Cmd + P: Take Picture
                if ((e.ctrlKey || e.metaKey) && e.key === "p") {
                    e.preventDefault();
                    document.getElementById("take-picture-btn").click();
                }

                // Ctrl/Cmd + V: Record Video
                if ((e.ctrlKey || e.metaKey) && e.key === "v") {
                    e.preventDefault();
                    document.getElementById("record-video-btn").click();
                }

                // Ctrl/Cmd + D: Download All Pictures
                if ((e.ctrlKey || e.metaKey) && e.key === "d" && !e.shiftKey) {
                    e.preventDefault();
                    downloadAllPictures();
                }

                // Ctrl/Cmd + Shift + D: Download All Videos
                if ((e.ctrlKey || e.metaKey) && e.key === "D") {
                    e.preventDefault();
                    downloadAllVideos();
                }
            });

            // Show keyboard shortcuts on page load
            document.addEventListener("DOMContentLoaded", function () {
                console.log("MintCam Keyboard Shortcuts:");
                console.log("Ctrl/Cmd + P: Take Picture");
                console.log("Ctrl/Cmd + V: Record Video");
                console.log("Ctrl/Cmd + D: Download All Pictures");
                console.log("Ctrl/Cmd + Shift + D: Download All Videos");
            });
        </script>
    </body>
</html>
